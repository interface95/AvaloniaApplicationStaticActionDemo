name: Build and Publish AOT

on:
  push:
    tags:
      - 'v*'  # ä»…åœ¨å‘å¸ƒç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
    paths-ignore:
      - "*.md"
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      id-token: write
      attestations: write
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - uses: TheMrMilchmann/setup-msvc-dev@v3
        with:
          arch: x64

      - name: Generate Version
        id: version
        shell: bash
        run: |
          # Generate version based on tag
          GIT_HASH=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date +'%Y%m%d')
          
          # Extract version from tag (e.g., v1.0.0 -> 1.0.0)
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # Fallback to commit count if no tag
            MAJOR_VERSION=1
            MINOR_VERSION=0
            BUILD_NUMBER=$(git rev-list --count HEAD)
            VERSION="${MAJOR_VERSION}.${MINOR_VERSION}.${BUILD_NUMBER}"
          fi
          
          FULL_VERSION="${VERSION}.0"

          echo "Generated version: ${VERSION}"
          echo "Full version: ${FULL_VERSION}"
          echo "Git hash: ${GIT_HASH}"
          echo "Build date: ${BUILD_DATE}"

          # Set outputs and environment variables
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "git_hash=${GIT_HASH}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "tag_name=v${VERSION}" >> $GITHUB_OUTPUT

          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "FULL_VERSION=${FULL_VERSION}" >> $GITHUB_ENV
          echo "GIT_HASH=${GIT_HASH}" >> $GITHUB_ENV
          echo "BUILD_DATE=${BUILD_DATE}" >> $GITHUB_ENV

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Prepare
        working-directory: ${{github.workspace}}
        shell: bash
        run: |
          echo "ğŸš€ å¼€å§‹å‡†å¤‡æ„å»ºç¯å¢ƒ..."
          echo "ğŸ“¦ ä¸‹è½½ UPX å‹ç¼©å·¥å…·..."
          curl -OL https://github.com/upx/upx/releases/download/v5.0.0/upx-5.0.0-win64.zip
          7z e -y ./*.zip -o"."
          
          echo "ğŸ“š ä¸‹è½½é™æ€åº“æ–‡ä»¶..."
          mkdir libs && cd libs
          curl -OL https://github.com/2ndlab/ANGLE.Static/releases/download/v2.0.0-pre/angle-x64-windows-static-chromium-7151-10.0.26100.0.7z
          curl -OL https://github.com/2ndlab/SkiaSharp.Static/releases/download/v2.0.0-pre/libHarfBuzzSharp-10.0.26100.0.7z
          curl -OL https://github.com/2ndlab/SkiaSharp.Static/releases/download/v2.0.0-pre/libSkiaSharp-2.88.9-10.0.26100.0.7z
          7z e -y angle-x64-windows-static-chromium-7151-10.0.26100.0.7z 
          7z e -y libHarfBuzzSharp-10.0.26100.0.7z
          7z e -y libSkiaSharp-2.88.9-10.0.26100.0.7z
          ls -al
          echo "ğŸ“ åˆ›å»º native ç›®å½•å¹¶ç§»åŠ¨é™æ€åº“æ–‡ä»¶..."
          mkdir -p ../AvaloniaApplicationStaticActionDemo/native
          mv *.lib *.pdb ../AvaloniaApplicationStaticActionDemo/native/
          echo "âœ… é™æ€åº“å‡†å¤‡å®Œæˆ"

      - name: Configure NuGet sources
        run: |
          echo "ğŸ”§ é…ç½® NuGet åŒ…æº..."
          
          # Clear existing sources and add nuget.org and Avalonia nightly
          dotnet nuget remove source nuget.org || true
          dotnet nuget add source https://api.nuget.org/v3/index.json --name nuget.org
          
          # Add Avalonia nightly feed for latest packages
          echo "ğŸ“¦ æ·»åŠ  Avalonia å¤œé—´æ„å»ºæº..."
          dotnet nuget add source https://nuget-feed-nightly.avaloniaui.net/v3/index.json --name AvaloniaNightly

          echo "âœ… å·²é…ç½®çš„åŒ…æº:"
          dotnet nuget list source
        shell: bash

      - name: Restore dependencies
        run: |
          echo "ğŸ“¥ å¼€å§‹æ¢å¤é¡¹ç›®ä¾èµ–..."
          echo "â³ è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´..."
          dotnet restore AvaloniaApplicationStaticActionDemo/AvaloniaApplicationStaticActionDemo.csproj --verbosity detailed
          echo "âœ… ä¾èµ–æ¢å¤å®Œæˆ!"
        shell: bash

      - name: Build
        working-directory: ${{github.workspace}}
        shell: pwsh
        run: |
          echo "ğŸš€ å¼€å§‹ AOT ç¼–è¯‘å’Œé™æ€é“¾æ¥..."
          echo "â±ï¸  é¦–æ¬¡æ„å»ºå¯èƒ½éœ€è¦ 15-30 åˆ†é’Ÿ"
          echo "ğŸ“¦ åµŒå…¥æ‰€æœ‰ä¾èµ–åº“åˆ°å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶..."
          echo "ğŸ”§ ç¼–è¯‘ä¸ºåŸç”Ÿä»£ç å¹¶é™æ€é“¾æ¥..."
          
          msbuild /m /t:restore AvaloniaApplicationStaticActionDemo.sln /p:Configuration=Release /p:Platform="Any CPU"
          dotnet publish AvaloniaApplicationStaticActionDemo/AvaloniaApplicationStaticActionDemo.csproj -r win-x64 -c Release --self-contained true
          
          echo "âœ… AOT ç¼–è¯‘å®Œæˆ!"
          echo "ğŸ“Š æ£€æŸ¥è¾“å‡ºæ–‡ä»¶å¤§å°..."
          # æŸ¥æ‰¾å®é™…çš„å¯æ‰§è¡Œæ–‡ä»¶ä½ç½®
          $exePath = Get-ChildItem -Path "AvaloniaApplicationStaticActionDemo" -Recurse -Name "AvaloniaApplicationStaticActionDemo.exe" | Select-Object -First 1
          if ($exePath) {
            $fullPath = Join-Path "AvaloniaApplicationStaticActionDemo" $exePath
            $size = (Get-Item $fullPath).Length
            $sizeMB = [math]::Round($size / 1MB, 2)
            echo "ğŸ“ å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: $sizeMB MB"
            echo "ğŸ“ æ–‡ä»¶ä½ç½®: $fullPath"
          }
          
          # æŸ¥æ‰¾å¹¶ç§»åŠ¨æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶åˆ°æ ¹ç›®å½•
          $publishDir = Get-ChildItem -Path "AvaloniaApplicationStaticActionDemo" -Recurse -Directory -Name "*publish*" | Select-Object -First 1
          if ($publishDir) {
            $fullPublishDir = Join-Path "AvaloniaApplicationStaticActionDemo" $publishDir
            echo "ğŸ“ å‘å¸ƒç›®å½•: $fullPublishDir"
            Get-ChildItem -Path $fullPublishDir | Move-Item -Destination "."
          } else {
            # å¤‡ç”¨æ–¹æ¡ˆï¼šæŸ¥æ‰¾ bin ç›®å½•
            $binDir = Get-ChildItem -Path "AvaloniaApplicationStaticActionDemo" -Recurse -Directory -Name "*bin*" | Where-Object { $_ -like "*Release*" -and $_ -like "*win-x64*" } | Select-Object -First 1
            if ($binDir) {
              $fullBinDir = Join-Path "AvaloniaApplicationStaticActionDemo" $binDir
              echo "ğŸ“ ä½¿ç”¨ bin ç›®å½•: $fullBinDir"
              Get-ChildItem -Path $fullBinDir -File | Move-Item -Destination "."
            }
          }

      - name: Package
        working-directory: ${{github.workspace}}
        shell: pwsh
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…å‘å¸ƒæ–‡ä»¶..."
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç»è¢« UPX å‹ç¼©
          $isAlreadyPacked = $false
          try {
            ./upx.exe -t .\AvaloniaApplicationStaticActionDemo.exe 2>$null
            if ($LASTEXITCODE -eq 0) {
              $isAlreadyPacked = $true
              echo "â„¹ï¸  æ–‡ä»¶å·²ç»è¢« UPX å‹ç¼©è¿‡"
            }
          } catch {
            echo "â„¹ï¸  æ–‡ä»¶æœªè¢« UPX å‹ç¼©"
          }
          
          if (-not $isAlreadyPacked) {
            # ä½¿ç”¨ UPX è¿›è¡Œæè‡´å‹ç¼©
            echo "ğŸ—œï¸  ä½¿ç”¨ UPX è¿›è¡Œæè‡´å‹ç¼©..."
            ./upx.exe --ultra-brute --overlay=strip .\AvaloniaApplicationStaticActionDemo.exe -o AvaloniaApplicationStaticActionDemo.UPX.exe
          } else {
            # å¦‚æœå·²ç»å‹ç¼©ï¼Œç›´æ¥å¤åˆ¶
            echo "ğŸ“‹ å¤åˆ¶å·²å‹ç¼©çš„æ–‡ä»¶..."
            Copy-Item .\AvaloniaApplicationStaticActionDemo.exe .\AvaloniaApplicationStaticActionDemo.UPX.exe
          }
          
          # åˆ›å»ºå‹ç¼©åŒ…
          echo "ğŸ“ åˆ›å»ºå‘å¸ƒåŒ…..."
          if (Test-Path ".\AvaloniaApplicationStaticActionDemo.pdb") {
            7z a -y -mx9 AvaloniaApplicationStaticActionDemo-v${{ env.VERSION }}.7z ./AvaloniaApplicationStaticActionDemo.exe ./AvaloniaApplicationStaticActionDemo.pdb
          } else {
            7z a -y -mx9 AvaloniaApplicationStaticActionDemo-v${{ env.VERSION }}.7z ./AvaloniaApplicationStaticActionDemo.exe
          }
          
          if (Test-Path ".\AvaloniaApplicationStaticActionDemo.UPX.exe") {
            7z a -y -mx9 AvaloniaApplicationStaticActionDemo-UPX-v${{ env.VERSION }}.7z ./AvaloniaApplicationStaticActionDemo.UPX.exe
          } else {
            echo "âš ï¸  UPX æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ UPX ç‰ˆæœ¬"
          }
          
          echo "âœ… æ‰“åŒ…å®Œæˆ!"

      - name: List dir
        working-directory: ${{github.workspace}}
        shell: bash
        run: |
          echo "ğŸ“‹ æœ€ç»ˆæ–‡ä»¶åˆ—è¡¨:"
          ls -al .

      - uses: actions/upload-artifact@v4
        id: upload-artifact-1
        with:
          name: AvaloniaApplicationStaticActionDemo-v${{ env.VERSION }}.7z
          path: AvaloniaApplicationStaticActionDemo-v${{ env.VERSION }}.7z

      - uses: actions/upload-artifact@v4
        id: upload-artifact-2
        with:
          name: AvaloniaApplicationStaticActionDemo-UPX-v${{ env.VERSION }}.7z
          path: AvaloniaApplicationStaticActionDemo-UPX-v${{ env.VERSION }}.7z

      - uses: actions/attest-build-provenance@v2
        with:
          subject-name: AvaloniaApplicationStaticActionDemo-v${{ env.VERSION }}.7z
          subject-digest: sha256:${{ steps.upload-artifact-1.outputs.artifact-digest }}

      - uses: actions/attest-build-provenance@v2
        with:
          subject-name: AvaloniaApplicationStaticActionDemo-UPX-v${{ env.VERSION }}.7z
          subject-digest: sha256:${{ steps.upload-artifact-2.outputs.artifact-digest }}

      - name: Release artifacts
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            AvaloniaApplicationStaticActionDemo-v${{ env.VERSION }}.7z
            AvaloniaApplicationStaticActionDemo-UPX-v${{ env.VERSION }}.7z
          body: |
            ## Avalonia é™æ€æ“ä½œæ¼”ç¤º v${{ env.VERSION }}

            **æ„å»ºæ—¥æœŸ**: ${{ env.BUILD_DATE }}
            **Git æäº¤**: ${{ env.GIT_HASH }}

            ### ä¸‹è½½æ–‡ä»¶
            - **æ ‡å‡†ç‰ˆæœ¬**: AvaloniaApplicationStaticActionDemo-v${{ env.VERSION }}.7z
            - **UPX å‹ç¼©ç‰ˆæœ¬**: AvaloniaApplicationStaticActionDemo-UPX-v${{ env.VERSION }}.7z

            ### åŠŸèƒ½ç‰¹æ€§
            - Avalonia UI æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œä½¿ç”¨ SkiaSharp å›¾å½¢åº“
            - .NET 9 AOT ç¼–è¯‘ï¼Œå®ç°åŸç”Ÿæ€§èƒ½
            - çœŸæ­£çš„å•æ–‡ä»¶é™æ€é“¾æ¥ï¼Œæ— éœ€å¤–éƒ¨ DLL
            - é«˜æ€§èƒ½ 2D å›¾å½¢æ¸²æŸ“
            - è‡ªåŠ¨ç‰ˆæœ¬ç¼–å·

            ### å®‰è£…è¯´æ˜
            1. ä¸‹è½½é€‚åˆçš„ 7z æ–‡ä»¶
            2. è§£å‹åˆ°æ‰€éœ€ä½ç½®
            3. ç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ— éœ€å®‰è£…ï¼‰

            ### ç³»ç»Ÿè¦æ±‚
            - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬ (x64)

            ### ç‰ˆæœ¬å†å²
            è¿™æ˜¯åŸºäºæäº¤ #${{ env.VERSION }} è‡ªåŠ¨ç”Ÿæˆçš„å‘å¸ƒç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}